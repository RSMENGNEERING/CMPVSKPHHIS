<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Household Survey Form</title>
  <style>
    /* Previous CSS unchanged */
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f4f4f9;
    }
    h1 {
      color: #2c3e50;
      text-align: center;
      font-size: 1.8em;
      margin-bottom: 20px;
      padding: 10px;
      background-color: #ecf0f1;
      border-radius: 5px;
    }
    h2, h3, h4 {
      color: #333;
    }
    form {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    label {
      display: block;
      margin: 10px 0 5px;
      font-weight: bold;
    }
    input, select, textarea {
      width: calc(100% - 20px);
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      padding: 10px 20px;
      background-color: #007bff;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background-color: #0056b3;
    }
    .vehicle-entry, .member-entry, .trip-entry, .transfer-entry {
      border: 1px solid #e0e0e0;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
    }
    .conditional-fields {
      margin-left: 20px;
      padding: 10px;
      background-color: #f9f9f9;
      border-radius: 4px;
    }
    .transfer-entry {
      background-color: #fff;
    }
    .transfer-entry label {
      margin: 5px 0;
    }
    .transfer-entry input, .transfer-entry select {
      width: calc(100% - 20px);
      padding: 6px;
    }
    .error {
      color: red;
      font-size: 0.9em;
    }
    @media (max-width: 600px) {
      input, select, textarea {
        width: 100%;
      }
      h1 {
        font-size: 1.5em;
      }
    }
  </style>
</head>
<body>
  <h1>REVIEW & REVISION OF COMPREHENSIVE MOBILITY PLAN (CMP) FOR VISAKHAPATNAM</h1>
  <form id="survey-form">
    <h2>Part 1 - Household Information</h2>
    
    <label>Surveyor Name: <input type="text" name="surveyor_name" required></label>
    <label>Household ID: <input type="text" name="household_id" id="household_id" readonly></label>
    <label>Submission Date: <input type="date" name="submission_date" id="submission_date" required></label>
    <label>1. Ward No.: <input type="text" name="ward_no" required></label>
    <label>2. TAZ No.: <input type="text" name="taz_no" required></label>
    <label>3. Name of the Head of the Household: <input type="text" name="head_name" required></label>

    <label>4. Address of the Household:</label>
    <input type="text" id="address" name="address" placeholder="Click 'Get Location' to autofill" required>
    <button type="button" onclick="getLocation()">Get Location</button>
    <input type="text" id="latitude" name="latitude" placeholder="Latitude" readonly>
    <input type="text" id="longitude" name="longitude" placeholder="Longitude" readonly>

    <label>5. Telephone/ Mobile No.: <input type="tel" name="mobile"></label>
    <label>6. Household Type:
      <select name="household_type">
        <option>Apartment</option>
        <option>Independent House</option>
        <option>Service or Shared Apartment</option>
        <option>Informal Housing</option>
      </select>
    </label>

    <label>7. House Ownership:
      <select name="house_ownership">
        <option>Owned</option>
        <option>Rented</option>
        <option>Employer Provided</option>
      </select>
    </label>

    <label>8. No. of Rooms:
      <select name="num_rooms">
        <option>1 Room</option>
        <option>1RK</option>
        <option>1BHK</option>
        <option>2BHK</option>
        <option>3BHK</option>
        <option>4BHK</option>
        <option>5BHK</option>
        <option>>5BHK</option>
      </select>
    </label>
    <label>9. No. of Earners in Household: <input type="number" name="num_earners" min="0" required></label>
    <label>10. Monthly Income (in Rs.):
      <select name="income" required>
        <option value="0-10000">0 - 10,000</option>
        <option value="10001-20000">10,001 - 20,000</option>
        <option value="20001-30000">20,001 - 30,000</option>
        <option value="30001-50000">30,001 - 50,000</option>
        <option value="50001-75000">50,001 - 75,000</option>
        <option value="75001-100000">75,001 - 1,00,000</option>
        <option value="100001-200000">1,00,001 - 2,00,000</option>
        <option value=">200000">Above 2,00,000</option>
      </select>
    </label>

    <label>11. No. of Vehicles Owned by Household:</label>
    <div id="vehicles">
      <div class="vehicle-entry">
        <label>Vehicle Type:
          <select name="veh_type[]">
            <option value="Car">Car</option>
            <option value="Two-Wheeler">Two-Wheeler</option>
            <option value="Bicycle">Bicycle</option>
            <option value="Auto-Rickshaw">Auto-Rickshaw</option>
            <option value="None">None</option>
          </select>
        </label>
        <label>Ownership Type:
          <select name="ownership_type[]">
            <option value="Owned">Owned</option>
            <option value="Hired">Hired</option>
          </select>
        </label>
        <label>Fuel Type:
          <select name="fuel_type[]">
            <option value="Petrol">Petrol</option>
            <option value="Diesel">Diesel</option>
            <option value="Electric">Electric</option>
            <option value="CNG">CNG</option>
            <option value="None">None</option>
          </select>
        </label>
        <label>Parking Type:
          <select name="parking_type[]">
            <option value="Private Space">Private Space</option>
            <option value="On Street">On Street</option>
          </select>
        </label>
      </div>
    </div>
    <button type="button" onclick="addVehicle()">+ Add Another Vehicle</button>

    <label>16. Monthly Expenditure (Rs.):</label>
    <label>Transport: <input type="number" name="exp_transport" min="0"></label>
    <label>Housing: <input type="number" name="exp_housing" min="0"></label>
    <label>Education: <input type="number" name="exp_education" min="0"></label>
    <label>Food: <input type="number" name="exp_food" min="0"></label>
    <label>Health: <input type="number" name="exp_health" min="0"></label>
    <label>Others: <input type="number" name="exp_others" min="0"></label>

    <label>17. Nearest Public Transport/IPT Station:
      <select name="nearest_pt_station">
        <option value="Bus Station">Bus Station</option>
        <option value="Railway Station">Railway Station</option>
        <option value="IPT Stand">IPT Stand</option>
      </select>
    </label>
    <label>18. Distance to PT/IPT station (in km): <input type="number" step="0.01" name="pt_distance" min="0"></label>
    <label>19. Walk Time (in minutes): <input type="number" name="walk_time" min="0"></label>
    <label>20. Average Waiting Time (in minutes): <input type="number" name="waiting_time" min="0"></label>
    <label>21. How Often Used in Week: <input type="text" name="weekly_usage"></label>
    <label>22. Feedback:
      <select name="pt_feedback">
        <option value="Reliable">Reliable</option>
        <option value="Safe">Safe</option>
        <option value="Expensive">Expensive</option>
      </select>
    </label>
    <label>23. Any Suggestion/Improvements: <textarea name="pt_suggestions"></textarea></label>

    <hr>
    <h2>Part 2 - Personal Level Information</h2>
    <div id="members">
      <div class="member-entry" data-member-id="M1">
        <label>Member ID: <input type="text" name="member_id[]" readonly value="M1"></label>
        <label>Relation with Head of the Family:
          <select name="relation[]">
            <option value="1">Self</option>
            <option value="2">Wife/Husband</option>
            <option value="3">Son/Daughter</option>
            <option value="4">Father/Mother</option>
            <option value="5">Brother/Sister</option>
            <option value="6">Grandfather/Grandmother</option>
            <option value="7">Others</option>
          </select>
        </label>
        <label>Age: <input type="number" name="age[]" min="0"></label>
        <label>Gender:
          <select name="gender[]">
            <option value="1">Male</option>
            <option value="2">Female</option>
            <option value="3">Other (Specify)</option>
          </select>
        </label>
        <label>Marital Status:
          <select name="marital_status[]">
            <option value="">Select</option>
            <option value="Married">Married</option>
            <option value="Unmarried">Unmarried</option>
          </select>
        </label>
        <label>Education:
          <select name="education[]">
            <option value="1">Illiterate</option>
            <option value="2">Pre-Primary</option>
            <option value="3">Primary (5th Pass)</option>
            <option value="4">Secondary (10th Pass)</option>
            <option value="5">Higher Secondary (12th Pass)</option>
            <option value="6">Technical Diploma</option>
            <option value="7">Graduate</option>
            <option value="8">Post Graduate & Above</option>
            <option value="9">Other/Literate without Formal Education</option>
          </select>
        </label>
        <label>Occupation/Type of Service:
          <select name="occupation[]">
            <option value="1">Employed (Full Time)</option>
            <option value="2">Employed (Part Time)</option>
            <option value="3">Business/Work Related</option>
            <option value="4">Employers Business</option>
            <option value="5">Daily Wages</option>
            <option value="6">Student</option>
            <option value="7">Home maker</option>
            <option value="8">Retired</option>
            <option value="9">Unemployed</option>
            <option value="10">Resident Maid/Driver/Caretaker</option>
            <option value="11">Others</option>
          </select>
        </label>
        <label>Place of Employment/Education:
          <select name="employment_place[]">
            <option value="1">Residential</option>
            <option value="2">Industry/Factory</option>
            <option value="3">Warehouse</option>
            <option value="4">Office/ Office Complex</option>
            <option value="5">Film/Television/Media Industry</option>
            <option value="6">Shop/Showroom/Mall</option>
            <option value="7">Restaurant/Eating Place</option>
            <option value="8">Hotel</option>
            <option value="9">Entertainment/Tourism</option>
            <option value="10">Place of Education (School/College etc.)</option>
            <option value="11">Health Facility</option>
            <option value="12">Agriculture</option>
            <option value="13">Construction Site</option>
            <option value="14">Varies day to day</option>
            <option value="15">Others</option>
          </select>
        </label>
        <label>Income per month (Rs.):
          <select name="income_personal[]">
            <option value="0">0</option>
            <option value="1-2500">1 - 2,500</option>
            <option value="2501-5000">2,501 - 5,000</option>
            <option value="5001-7500">5,001 - 7,500</option>
            <option value="7501-10000">7,501 - 10,000</option>
            <option value="10001-15000">10,001 - 15,000</option>
            <option value="15001-20000">15,001 - 20,000</option>
            <option value="20001-25000">20,001 - 25,000</option>
            <option value="25001-30000">25,001 - 30,000</option>
            <option value="30001-40000">30,001 - 40,000</option>
            <option value="40001-50000">40,001 - 50,000</option>
            <option value=">50000">Above 50,000</option>
          </select>
        </label>
        <label>Driving License Holder:
          <select name="license[]">
            <option value="1">No License</option>
            <option value="2">Two Wheeler</option>
            <option value="3">Car</option>
            <option value="4">Both</option>
            <option value="5">Others (Specify)</option>
          </select>
        </label>
        <label>Rail/Bus Pass Holder:
          <select name="travel_pass[]">
            <option value="1">No Pass</option>
            <option value="2">Rail pass</option>
            <option value="3">Bus pass</option>
            <option value="4">Others (Specify)</option>
          </select>
        </label>
        <label>Cost of Travel Pass (Rs.): <input type="number" name="pass_cost[]" min="0"></label>
        <label>Avg Monthly Travel Expenditure (Rs.): <input type="number" name="travel_expense[]" min="0"></label>
        
        <h3>Part 3 - Trip Information</h3>
        <div class="trip-entries">
          <div class="trip-entry">
            <label>Trip ID: <input type="text" name="trip_id[]" readonly></label>
            <label>Mode of Transport:
              <select name="mode_of_transport[]" onchange="toggleConditionalFields(this)">
                <option value="1">Walk</option>
                <option value="2">Bicycle</option>
                <option value="3">Auto Rickshaw</option>
                <option value="4">Two Wheeler</option>
                <option value="5">Car</option>
                <option value="6">Taxi</option>
                <option value="7">School Bus</option>
                <option value="8">Bus</option>
                <option value="9">Train</option>
                <option value="10">App Based Two Wheeler</option>
                <option value="11">App Based Taxi</option>
                <option value="12">App Based Auto</option>
              </select>
            </label>
            <label>Origin Name: <input type="text" name="origin_name[]"></label>
            <label>Destination Name: <input type="text" name="destination_name[]"></label>
            <label>Trip Start Time: <input type="time" name="start_time[]"></label>
            <label>Trip End Time: <input type="time" name="end_time[]"></label>
            <label>Travel Cost: <input type="number" name="travel_cost[]" min="0"></label>
            <label>Travel Time: <input type="time" name="travel_time[]"></label>      
            <label>Trip Purpose:
              <select name="trip_purpose[]">
                <option value="1">Work</option>
                <option value="2">Education</option>
                <option value="3">Shopping</option>
                <option value="4">Health</option>
                <option value="5">Leisure</option>
                <option value="6">Other</option>
              </select>
            </label>
            <div class="conditional-fields" style="display: none;">
              <label>Number of Transfers:
                <input type="number" name="num_transfers[]" min="0" max="5" onchange="updateTransferFields(this)">
              </label>
              <div class="transfer-entries"></div>
            </div>
          </div>
        </div>
        <button type="button" onclick="addTrip(this)">+ Add Another Trip</button>
      </div>
    </div>
    <button type="button" onclick="addMember()">+ Add Another Member</button>
    <button type="submit">Submit Survey</button>
    <label>Export Data From: <input type="date" id="from_date"></label>
    <label>To: <input type="date" id="to_date"></label>
    <button type="button" onclick="downloadExcel()">Download and Share via WhatsApp</button>
  </form>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    // Household ID Generator
    const householdId = Date.now();
    document.getElementById('household_id').value = `H${householdId}`;

    // Set today's date as default for submission_date
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('submission_date').value = today;

    // Counters for Member and Trip IDs
    let memberIdCounter = 1;
    const tripCounters = { 'M1': 1 }; // Initialize trip counter for first member

    // Set first trip ID for first member
    document.querySelector('.member-entry[data-member-id="M1"] input[name="trip_id[]"]').value = `H${householdId}-M1-T1`;

    // Initialize localStorage if not already set
    if (!localStorage.getItem('surveyData')) {
      localStorage.setItem('surveyData', JSON.stringify([]));
    }

    // Geolocation with Reverse Geocoding
    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(async (position) => {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;
          document.getElementById('latitude').value = lat;
          document.getElementById('longitude').value = lon;

          try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);
            const data = await response.json();
            document.getElementById('address').value = data.display_name || 'Address not found';
          } catch (error) {
            console.error('Error fetching address:', error);
            alert('Could not fetch address. Please enter manually.');
          }
        }, (error) => {
          alert('Geolocation error: ' + error.message);
        });
      } else {
        alert('Geolocation is not supported by this browser.');
      }
    }

    // Add Vehicle
    function addVehicle() {
      const vehicles = document.getElementById('vehicles');
      const entry = vehicles.querySelector('.vehicle-entry').cloneNode(true);
      entry.querySelectorAll('input').forEach(input => input.value = '');
      entry.querySelectorAll('select').forEach(select => select.selectedIndex = 0);
      vehicles.appendChild(entry);
    }

    // Add Member
    function addMember() {
      const members = document.getElementById('members');
      memberIdCounter++;
      const newMemberId = `M${memberIdCounter}`;
      tripCounters[newMemberId] = 1; // Initialize trip counter for new member
      
      const entry = document.createElement('div');
      entry.className = 'member-entry';
      entry.dataset.memberId = newMemberId;
      const tripId = `H${householdId}-${newMemberId}-T1`;
      entry.innerHTML = `
        <label>Member ID: <input type="text" name="member_id[]" readonly value="${newMemberId}"></label>
        <label>Relation with Head of the Family:
          <select name="relation[]">
            <option value="1">Self</option>
            <option value="2">Wife/Husband</option>
            <option value="3">Son/Daughter</option>
            <option value="4">Father/Mother</option>
            <option value="5">Brother/Sister</option>
            <option value="6">Grandfather/Grandmother</option>
            <option value="7">Others</option>
          </select>
        </label>
        <label>Age: <input type="number" name="age[]" min="0"></label>
        <label>Gender:
          <select name="gender[]">
            <option value="1">Male</option>
            <option value="2">Female</option>
            <option value="3">Other (Specify)</option>
          </select>
        </label>
        <label>Marital Status:
          <select name="marital_status[]">
            <option value="">Select</option>
            <option value="Married">Married</option>
            <option value="Unmarried">Unmarried</option>
          </select>
        </label>
        <label>Education:
          <select name="education[]">
            <option value="1">Illiterate</option>
            <option value="2">Pre-Primary</option>
            <option value="3">Primary (5th Pass)</option>
            <option value="4">Secondary (10th Pass)</option>
            <option value="5">Higher Secondary (12th Pass)</option>
            <option value="6">Technical Diploma</option>
            <option value="7">Graduate</option>
            <option value="8">Post Graduate & Above</option>
            <option value="9">Other/Literate without Formal Education</option>
          </select>
        </label>
        <label>Occupation/Type of Service:
          <select name="occupation[]">
            <option value="1">Employed (Full Time)</option>
            <option value="2">Employed (Part Time)</option>
            <option value="3">Business/Work Related</option>
            <option value="4">Employers Business</option>
            <option value="5">Daily Wages</option>
            <option value="6">Student</option>
            <option value="7">Home maker</option>
            <option value="8">Retired</option>
            <option value="9">Unemployed</option>
            <option value="10">Resident Maid/Driver/Caretaker</option>
            <option value="11">Others</option>
          </select>
        </label>
        <label>Place of Employment/Education:
          <select name="employment_place[]">
            <option value="1">Residential</option>
            <option value="2">Industry/Factory</option>
            <option value="3">Warehouse</option>
            <option value="4">Office/ Office Complex</option>
            <option value="5">Film/Television/Media Industry</option>
            <option value="6">Shop/Showroom/Mall</option>
            <option value="7">Restaurant/Eating Place</option>
            <option value="8">Hotel</option>
            <option value="9">Entertainment/Tourism</option>
            <option value="10">Place of Education (School/College etc.)</option>
            <option value="11">Health Facility</option>
            <option value="12">Agriculture</option>
            <option value="13">Construction Site</option>
            <option value="14">Varies day to day</option>
            <option value="15">Others</option>
          </select>
        </label>
        <label>Income per month (Rs.):
          <select name="income_personal[]">
            <option value="0">0</option>
            <option value="1-2500">1 - 2,500</option>
            <option value="2501-5000">2,501 - 5,000</option>
            <option value="5001-7500">5,001 - 7,500</option>
            <option value="7501-10000">7,501 - 10,000</option>
            <option value="10001-15000">10,001 - 15,000</option>
            <option value="15001-20000">15,001 - 20,000</option>
            <option value="20001-25000">20,001 - 25,000</option>
            <option value="25001-30000">25,001 - 30,000</option>
            <option value="30001-40000">30,001 - 40,000</option>
            <option value="40001-50000">40,001 - 50,000</option>
            <option value=">50000">Above 50,000</option>
          </select>
        </label>
        <label>Driving License Holder:
          <select name="license[]">
            <option value="1">No License</option>
            <option value="2">Two Wheeler</option>
            <option value="3">Car</option>
            <option value="4">Both</option>
            <option value="5">Others (Specify)</option>
          </select>
        </label>
        <label>Rail/Bus Pass Holder:
          <select name="travel_pass[]">
            <option value="1">No Pass</option>
            <option value="2">Rail pass</option>
            <option value="3">Bus pass</option>
            <option value="4">Others (Specify)</option>
          </select>
        </label>
        <label>Cost of Travel Pass (Rs.): <input type="number" name="pass_cost[]" min="0"></label>
        <label>Avg Monthly Travel Expenditure (Rs.): <input type="number" name="travel_expense[]" min="0"></label>
        <h3>Part 3 - Trip Information</h3>
        <div class="trip-entries">
          <div class="trip-entry">
            <label>Trip ID: <input type="text" name="trip_id[]" readonly value="${tripId}"></label>
            <label>Mode of Transport:
              <select name="mode_of_transport[]" onchange="toggleConditionalFields(this)">
                <option value="1">Walk</option>
                <option value="2">Bicycle</option>
                <option value="3">Auto Rickshaw</option>
                <option value="4">Two Wheeler</option>
                <option value="5">Car</option>
                <option value="6">Taxi</option>
                <option value="7">School Bus</option>
                <option value="8">Bus</option>
                <option value="9">Train</option>
                <option value="10">App Based Two Wheeler</option>
                <option value="11">App Based Taxi</option>
                <option value="12">App Based Auto</option>
              </select>
            </label>
            <label>Origin Name: <input type="text" name="origin_name[]"></label>
            <label>Destination Name: <input type="text" name="destination_name[]"></label>
            <label>Trip Start Time: <input type="time" name="start_time[]"></label>
            <label>Trip End Time: <input type="time" name="end_time[]"></label>
            <label>Travel Cost: <input type="number" name="travel_cost[]" min="0"></label>
            <label>Travel Time: <input type="time" name="travel_time[]"></label>      
            <label>Trip Purpose:
              <select name="trip_purpose[]">
                <option value="1">Work</option>
                <option value="2">Education</option>
                <option value="3">Shopping</option>
                <option value="4">Health</option>
                <option value="5">Leisure</option>
                <option value="6">Other</option>
              </select>
            </label>
            <div class="conditional-fields" style="display: none;">
              <label>Number of Transfers:
                <input type="number" name="num_transfers[]" min="0" max="5" onchange="updateTransferFields(this)">
              </label>
              <div class="transfer-entries"></div>
            </div>
          </div>
        </div>
        <button type="button" onclick="addTrip(this)">+ Add Another Trip</button>
      `;
      members.appendChild(entry);
    }

    // Add Trip
    function addTrip(button) {
      const tripEntries = button.parentElement.querySelector('.trip-entries');
      const memberEntry = button.closest('.member-entry');
      const memberId = memberEntry.dataset.memberId;
      tripCounters[memberId] = (tripCounters[memberId] || 1) + 1;
      const tripId = `H${householdId}-${memberId}-T${tripCounters[memberId]}`;
      const entry = tripEntries.querySelector('.trip-entry').cloneNode(true);
      entry.querySelectorAll('input').forEach(input => input.value = '');
      entry.querySelectorAll('select').forEach(select => select.selectedIndex = 0);
      entry.querySelector('input[name="trip_id[]"]').value = tripId;
      entry.querySelector('.conditional-fields').style.display = 'none';
      entry.querySelector('.transfer-entries').innerHTML = '';
      tripEntries.appendChild(entry);
    }

    // Toggle Conditional Fields based on Mode of Transport
    function toggleConditionalFields(select) {
      const conditionalFields = select.closest('.trip-entry').querySelector('.conditional-fields');
      const selectedMode = select.value;
      if (['3', '8', '9'].includes(selectedMode)) {
        conditionalFields.style.display = 'block';
      } else {
        conditionalFields.style.display = 'none';
        const transferEntries = conditionalFields.querySelector('.transfer-entries');
        transferEntries.innerHTML = '';
        conditionalFields.querySelector('input[name="num_transfers[]"]').value = '';
      }
    }

    // Update Transfer Fields based on Number of Transfers
    function updateTransferFields(input) {
      const numTransfers = parseInt(input.value) || 0;
      const transferEntries = input.closest('.conditional-fields').querySelector('.transfer-entries');
      transferEntries.innerHTML = '';

      for (let i = 0; i < numTransfers; i++) {
        const transferEntry = document.createElement('div');
        transferEntry.className = 'transfer-entry';
        transferEntry.innerHTML = `
          <h4>Transfer ${i + 1}</h4>
          <label>Stop Name: <input type="text" name="transfer_stop_name_${i}[]"></label>
          <label>Mode to Reach Stop:
            <select name="transfer_mode_${i}[]">
              <option value="Walk">Walk</option>
              <option value="Bicycle">Bicycle</option>
              <option value="Auto Rickshaw">Auto Rickshaw</option>
              <option value="Two Wheeler">Two Wheeler</option>
              <option value="Car">Car</option>
              <option value="Bus">Bus</option>
              <option value="Train">Train</option>
              <option value="Taxi">Taxi</option>
              <option value="App Based Two Wheeler">App Based Two Wheeler</option>
              <option value="App Based Taxi">App Based Taxi</option>
              <option value="App Based Auto">App Based Auto</option>
            </select>
          </label>
          <label>Cost to Stop (Rs.): <input type="number" name="transfer_cost_${i}[]" min="0"></label>
          <label>Time to Stop (minutes): <input type="number" name="transfer_time_${i}[]" min="0"></label>
          <label>Waiting Time at Stop (minutes): <input type="number" name="transfer_waiting_time_${i}[]" min="0"></label>
        `;
        transferEntries.appendChild(transferEntry);
      }
    }

    // Form Submission
    document.getElementById('survey-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      const data = {
        household: {},
        vehicles: [],
        members: [],
        trips: [],
        transfers: [],
        submission_date: formData.get('submission_date'),
        surveyor_name: formData.get('surveyor_name')
      };

      // Household Data
      data.household = {
        household_id: formData.get('household_id'),
        surveyor_name: formData.get('surveyor_name'),
        submission_date: formData.get('submission_date'),
        ward_no: formData.get('ward_no'),
        taz_no: formData.get('taz_no'),
        head_name: formData.get('head_name'),
        address: formData.get('address'),
        latitude: formData.get('latitude'),
        longitude: formData.get('longitude'),
        mobile: formData.get('mobile'),
        household_type: formData.get('household_type'),
        house_ownership: formData.get('house_ownership'),
        num_rooms: formData.get('num_rooms'),
        num_earners: formData.get('num_earners'),
        income: formData.get('income'),
        exp_transport: formData.get('exp_transport'),
        exp_housing: formData.get('exp_housing'),
        exp_education: formData.get('exp_education'),
        exp_food: formData.get('exp_food'),
        exp_health: formData.get('exp_health'),
        exp_others: formData.get('exp_others'),
        nearest_pt_station: formData.get('nearest_pt_station'),
        pt_distance: formData.get('pt_distance'),
        walk_time: formData.get('walk_time'),
        waiting_time: formData.get('waiting_time'),
        weekly_usage: formData.get('weekly_usage'),
        pt_feedback: formData.get('pt_feedback'),
        pt_suggestions: formData.get('pt_suggestions')
      };

      // Vehicles Data
      const vehicleEntries = document.querySelectorAll('.vehicle-entry');
      vehicleEntries.forEach((entry, index) => {
        data.vehicles.push({
          household_id: formData.get('household_id'),
          vehicle_number: index + 1,
          veh_type: entry.querySelector(`select[name="veh_type[]"]`).value,
          ownership_type: entry.querySelector(`select[name="ownership_type[]"]`).value,
          fuel_type: entry.querySelector(`select[name="fuel_type[]"]`).value,
          parking_type: entry.querySelector(`select[name="parking_type[]"]`).value
        });
      });

      // Members and Trips Data
      const memberEntries = document.querySelectorAll('.member-entry');
      let tripIndexOffset = 0;
      memberEntries.forEach((member, mIndex) => {
        const memberData = {
          household_id: formData.get('household_id'),
          member_id: formData.getAll('member_id[]')[mIndex],
          relation: formData.getAll('relation[]')[mIndex],
          age: formData.getAll('age[]')[mIndex],
          gender: formData.getAll('gender[]')[mIndex],
          marital_status: formData.getAll('marital_status[]')[mIndex],
          education: formData.getAll('education[]')[mIndex],
          occupation: formData.getAll('occupation[]')[mIndex],
          employment_place: formData.getAll('employment_place[]')[mIndex],
          income_personal: formData.getAll('income_personal[]')[mIndex],
          license: formData.getAll('license[]')[mIndex],
          travel_pass: formData.getAll('travel_pass[]')[mIndex],
          pass_cost: formData.getAll('pass_cost[]')[mIndex],
          travel_expense: formData.getAll('travel_expense[]')[mIndex]
        };
        data.members.push(memberData);

        // Trips for this member
        const tripEntries = member.querySelectorAll('.trip-entry');
        tripEntries.forEach((trip, tIndex) => {
          const globalTripIndex = tripIndexOffset + tIndex;
          const tripData = {
            household_id: formData.get('household_id'),
            member_id: memberData.member_id,
            trip_id: formData.getAll('trip_id[]')[globalTripIndex],
            mode_of_transport: formData.getAll('mode_of_transport[]')[globalTripIndex],
            origin_name: formData.getAll('origin_name[]')[globalTripIndex],
            destination_name: formData.getAll('destination_name[]')[globalTripIndex],
            start_time: formData.getAll('start_time[]')[globalTripIndex],
            end_time: formData.getAll('end_time[]')[globalTripIndex],
            travel_cost: formData.getAll('travel_cost[]')[globalTripIndex],
            travel_time: formData.getAll('travel_time[]')[globalTripIndex],
            trip_purpose: formData.getAll('trip_purpose[]')[globalTripIndex],
            num_transfers: formData.getAll('num_transfers[]')[globalTripIndex] || '0'
          };
          data.trips.push(tripData);

          // Transfers for this trip
          const numTransfers = parseInt(tripData.num_transfers) || 0;
          for (let i = 0; i < numTransfers; i++) {
            data.transfers.push({
              household_id: formData.get('household_id'),
              member_id: memberData.member_id,
              trip_id: tripData.trip_id,
              transfer_number: i + 1,
              stop_name: formData.getAll(`transfer_stop_name_${i}[]`)[globalTripIndex] || '',
              mode: formData.getAll(`transfer_mode_${i}[]`)[globalTripIndex] || '',
              cost: formData.getAll(`transfer_cost_${i}[]`)[globalTripIndex] || '',
              time: formData.getAll(`transfer_time_${i}[]`)[globalTripIndex] || '',
              waiting_time: formData.getAll(`transfer_waiting_time_${i}[]`)[globalTripIndex] || ''
            });
          }
        });
        tripIndexOffset += tripEntries.length;
      });

      // Store in localStorage
      const storedData = JSON.parse(localStorage.getItem('surveyData'));
      storedData.push(data);
      localStorage.setItem('surveyData', JSON.stringify(storedData));

      alert('Survey submitted successfully!');
      this.reset();
      document.getElementById('household_id').value = `H${Date.now()}`; // Generate new Household ID
      document.getElementById('submission_date').value = today;
      // Reset vehicles, members, and trips to initial state
      document.getElementById('vehicles').innerHTML = document.getElementById('vehicles').querySelector('.vehicle-entry').outerHTML;
      document.getElementById('members').innerHTML = `
        <div class="member-entry" data-member-id="M1">
          <label>Member ID: <input type="text" name="member_id[]" readonly value="M1"></label>
          <label>Relation with Head of the Family:
            <select name="relation[]">
              <option value="1">Self</option>
              <option value="2">Wife/Husband</option>
              <option value="3">Son/Daughter</option>
              <option value="4">Father/Mother</option>
              <option value="5">Brother/Sister</option>
              <option value="6">Grandfather/Grandmother</option>
              <option value="7">Others</option>
            </select>
          </label>
          <label>Age: <input type="number" name="age[]" min="0"></label>
          <label>Gender:
            <select name="gender[]">
              <option value="1">Male</option>
              <option value="2">Female</option>
              <option value="3">Other (Specify)</option>
            </select>
          </label>
          <label>Marital Status:
            <select name="marital_status[]">
              <option value="">Select</option>
              <option value="Married">Married</option>
              <option value="Unmarried">Unmarried</option>
            </select>
          </label>
          <label>Education:
            <select name="education[]">
              <option value="1">Illiterate</option>
              <option value="2">Pre-Primary</option>
              <option value="3">Primary (5th Pass)</option>
              <option value="4">Secondary (10th Pass)</option>
              <option value="5">Higher Secondary (12th Pass)</option>
              <option value="6">Technical Diploma</option>
              <option value="7">Graduate</option>
              <option value="8">Post Graduate & Above</option>
              <option value="9">Other/Literate without Formal Education</option>
            </select>
          </label>
          <label>Occupation/Type of Service:
            <select name="occupation[]">
              <option value="1">Employed (Full Time)</option>
              <option value="2">Employed (Part Time)</option>
              <option value="3">Business/Work Related</option>
              <option value="4">Employers Business</option>
              <option value="5">Daily Wages</option>
              <option value="6">Student</option>
              <option value="7">Home maker</option>
              <option value="8">Retired</option>
              <option value="9">Unemployed</option>
              <option value="10">Resident Maid/Driver/Caretaker</option>
              <option value="11">Others</option>
            </select>
          </label>
          <label>Place of Employment/Education:
            <select name="employment_place[]">
              <option value="1">Residential</option>
              <option value="2">Industry/Factory</option>
              <option value="3">Warehouse</option>
              <option value="4">Office/ Office Complex</option>
              <option value="5">Film/Television/Media Industry</option>
              <option value="6">Shop/Showroom/Mall</option>
              <option value="7">Restaurant/Eating Place</option>
              <option value="8">Hotel</option>
              <option value="9">Entertainment/Tourism</option>
              <option value="10">Place of Education (School/College etc.)</option>
              <option value="11">Health Facility</option>
              <option value="12">Agriculture</option>
              <option value="13">Construction Site</option>
              <option value="14">Varies day to day</option>
              <option value="15">Others</option>
            </select>
          </label>
          <label>Income per month (Rs.):
            <select name="income_personal[]">
              <option value="0">0</option>
              <option value="1-2500">1 - 2,500</option>
              <option value="2501-5000">2,501 - 5,000</option>
              <option value="5001-7500">5,001 - 7,500</option>
              <option value="7501-10000">7,501 - 10,000</option>
              <option value="10001-15000">10,001 - 15,000</option>
              <option value="15001-20000">15,001 - 20,000</option>
              <option value="20001-25000">20,001 - 25,000</option>
              <option value="25001-30000">25,001 - 30,000</option>
              <option value="30001-40000">30,001 - 40,000</option>
              <option value="40001-50000">40,001 - 50,000</option>
              <option value=">50000">Above 50,000</option>
            </select>
          </label>
          <label>Driving License Holder:
            <select name="license[]">
              <option value="1">No License</option>
              <option value="2">Two Wheeler</option>
              <option value="3">Car</option>
              <option value="4">Both</option>
              <option value="5">Others (Specify)</option>
            </select>
          </label>
          <label>Rail/Bus Pass Holder:
            <select name="travel_pass[]">
              <option value="1">No Pass</option>
              <option value="2">Rail pass</option>
              <option value="3">Bus pass</option>
              <option value="4">Others (Specify)</option>
            </select>
          </label>
          <label>Cost of Travel Pass (Rs.): <input type="number" name="pass_cost[]" min="0"></label>
          <label>Avg Monthly Travel Expenditure (Rs.): <input type="number" name="travel_expense[]" min="0"></label>
          <h3>Part 3 - Trip Information</h3>
          <div class="trip-entries">
            <div class="trip-entry">
              <label>Trip ID: <input type="text" name="trip_id[]" readonly value="H${householdId}-M1-T1"></label>
              <label>Mode of Transport:
                <select name="mode_of_transport[]" onchange="toggleConditionalFields(this)">
                  <option value="1">Walk</option>
                  <option value="2">Bicycle</option>
                  <option value="3">Auto Rickshaw</option>
                  <option value="4">Two Wheeler</option>
                  <option value="5">Car</option>
                  <option value="6">Taxi</option>
                  <option value="7">School Bus</option>
                  <option value="8">Bus</option>
                  <option value="9">Train</option>
                  <option value="10">App Based Two Wheeler</option>
                  <option value="11">App Based Taxi</option>
                  <option value="12">App Based Auto</option>
                </select>
              </label>
              <label>Origin Name: <input type="text" name="origin_name[]"></label>
              <label>Destination Name: <input type="text" name="destination_name[]"></label>
              <label>Trip Start Time: <input type="time" name="start_time[]"></label>
              <label>Trip End Time: <input type="time" name="end_time[]"></label>
              <label>Travel Cost: <input type="number" name="travel_cost[]" min="0"></label>
              <label>Travel Time: <input type="time" name="travel_time[]"></label>      
              <label>Trip Purpose:
                <select name="trip_purpose[]">
                  <option value="1">Work</option>
                  <option value="2">Education</option>
                  <option value="3">Shopping</option>
                  <option value="4">Health</option>
                  <option value="5">Leisure</option>
                  <option value="6">Other</option>
                </select>
              </label>
              <div class="conditional-fields" style="display: none;">
                <label>Number of Transfers:
                  <input type="number" name="num_transfers[]" min="0" max="5" onchange="updateTransferFields(this)">
                </label>
                <div class="transfer-entries"></div>
              </div>
            </div>
          </div>
          <button type="button" onclick="addTrip(this)">+ Add Another Trip</button>
        </div>
      `;
      memberIdCounter = 1;
      tripCounters['M1'] = 1;
    });

    // Download Excel and Share via WhatsApp
    function downloadExcel() {
      const fromDate = document.getElementById('from_date').value;
      const toDate = document.getElementById('to_date').value;
      if (!fromDate || !toDate) {
        alert('Please select both From and To dates.');
        return;
      }
      if (fromDate > toDate) {
        alert('From Date cannot be later than To Date.');
        return;
      }

      const storedData = JSON.parse(localStorage.getItem('surveyData')) || [];
      const filteredData = storedData.filter(item => item.submission_date >= fromDate && item.submission_date <= toDate);

      if (filteredData.length === 0) {
        alert('No data found for the selected date range.');
        return;
      }

      // Get the most recent surveyor name (assuming same surveyor for simplicity)
      const surveyorName = filteredData[filteredData.length - 1].surveyor_name.replace(/\s+/g, '_') || 'Unknown';

      // Prepare data for each sheet
      const households = [];
      const vehicles = [];
      const members = [];
      const trips = [];
      const transfers = [];

      filteredData.forEach(item => {
        // Households Sheet
        households.push(item.household);

        // Vehicles Sheet
        item.vehicles.forEach(vehicle => {
          vehicles.push({
            ...vehicle,
            submission_date: item.submission_date,
            surveyor_name: item.surveyor_name
          });
        });

        // Members Sheet
        item.members.forEach(member => {
          members.push({
            ...member,
            submission_date: item.submission_date,
            surveyor_name: item.surveyor_name
          });
        });

        // Trips Sheet
        item.trips.forEach(trip => {
          trips.push({
            ...trip,
            submission_date: item.submission_date,
            surveyor_name: item.surveyor_name
          });
        });

        // Transfers Sheet
        item.transfers.forEach(transfer => {
          transfers.push({
            ...transfer,
            submission_date: item.submission_date,
            surveyor_name: item.surveyor_name
          });
        });
      });

      // Create workbook
      const wb = XLSX.utils.book_new();

      // Households Sheet
      const householdWs = XLSX.utils.json_to_sheet(households);
      XLSX.utils.book_append_sheet(wb, householdWs, 'Households');

      // Vehicles Sheet
      const vehicleWs = XLSX.utils.json_to_sheet(vehicles);
      XLSX.utils.book_append_sheet(wb, vehicleWs, 'Vehicles');

      // Members Sheet
      const memberWs = XLSX.utils.json_to_sheet(members);
      XLSX.utils.book_append_sheet(wb, memberWs, 'Members');

      // Trips Sheet
      const tripWs = XLSX.utils.json_to_sheet(trips);
      XLSX.utils.book_append_sheet(wb, tripWs, 'Trips');

      // Transfers Sheet
      const transferWs = XLSX.utils.json_to_sheet(transfers);
      XLSX.utils.book_append_sheet(wb, transferWs, 'Transfers');

      // Write file
      const fileName = `Survey_${surveyorName}_${fromDate}_to_${toDate}.xlsx`;
      XLSX.writeFile(wb, fileName);

      // Open WhatsApp sharing windows
      const mobileNumbers = [
        '+919866897989', // Placeholder: Update with actual number
        '+918074716885', // Placeholder: Update with actual number
        '+919866997390', // Placeholder: Update with actual number
        '+919951020240'  // Placeholder: Update with actual number
      ];
      const message = `Survey data from ${surveyorName} for ${fromDate} to ${toDate}. File: ${fileName}. Please attach the downloaded file.`;
      mobileNumbers.forEach(number => {
        const encodedMessage = encodeURIComponent(message);
        const whatsappUrl = `https://wa.me/${number}?text=${encodedMessage}`;
        window.open(whatsappUrl, '_blank');
      });

      alert('Excel file downloaded. WhatsApp windows opened for sharing. Please attach the file manually.');
    }
  </script>
</body>
</html>